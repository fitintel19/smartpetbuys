{{/* 
Hugo shortcode for responsive images with srcset and WebP support
Usage: {{< responsive-image src="image.jpg" alt="Description" sizes="(max-width: 768px) 100vw, 50vw" >}}
*/}}

{{- $src := .Get "src" -}}
{{- $alt := .Get "alt" | default "" -}}
{{- $class := .Get "class" | default "" -}}
{{- $sizes := .Get "sizes" | default "(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1200px" -}}
{{- $loading := .Get "loading" | default "lazy" -}}
{{- $fetchpriority := .Get "fetchpriority" | default "" -}}

{{/* Define responsive breakpoints for mobile-first approach */}}
{{- $breakpoints := slice 320 375 414 568 768 1024 1200 1600 -}}

{{/* Try to get image as resource if it's local */}}
{{- $image := false -}}
{{- $isLocal := false -}}

{{/* Check if image is local (starts with / or doesn't contain ://) */}}
{{- if or (hasPrefix $src "/") (not (findRE "://" $src)) -}}
  {{- $isLocal = true -}}
  {{- with resources.Get (strings.TrimPrefix "/" $src) -}}
    {{- $image = . -}}
  {{- end -}}
{{- end -}}

{{/* If we have a local image resource, generate responsive variants */}}
{{- if $image -}}
  {{- $webpSrcset := slice -}}
  {{- $jpegSrcset := slice -}}
  
  {{/* Generate WebP and JPEG variants for each breakpoint */}}
  {{- range $breakpoints -}}
    {{- $width := . -}}
    {{- if le $width $image.Width -}}
      {{/* Generate JPEG variant */}}
      {{- $resizedJpeg := $image.Resize (printf "%dx q85" $width) -}}
      {{- $jpegSrcset = $jpegSrcset | append (printf "%s %dw" $resizedJpeg.RelPermalink $width) -}}
      
      {{/* Generate WebP variant */}}
      {{- $resizedWebp := $image.Resize (printf "%dx webp q85" $width) -}}
      {{- $webpSrcset = $webpSrcset | append (printf "%s %dw" $resizedWebp.RelPermalink $width) -}}
    {{- end -}}
  {{- end -}}
  
  {{/* Fallback image */}}
  {{- $fallback := $image.Resize "1200x q85" -}}
  
  {{/* Output picture element with WebP and JPEG sources */}}
  <picture class="responsive-image{{ with $class }} {{ . }}{{ end }}">
    {{- if $webpSrcset -}}
    <source type="image/webp" 
            srcset="{{ delimit $webpSrcset ", " }}" 
            sizes="{{ $sizes }}">
    {{- end -}}
    
    {{- if $jpegSrcset -}}
    <source type="image/jpeg" 
            srcset="{{ delimit $jpegSrcset ", " }}" 
            sizes="{{ $sizes }}">
    {{- end -}}
    
    <img src="{{ $fallback.RelPermalink }}" 
         alt="{{ $alt }}"
         loading="{{ $loading }}"
         {{- with $fetchpriority }} fetchpriority="{{ . }}"{{ end }}
         {{- with $class }} class="{{ . }}"{{ end }}
         width="{{ $fallback.Width }}"
         height="{{ $fallback.Height }}">
  </picture>

{{/* For external images, create optimized versions using URL parameters where possible */}}
{{- else -}}
  {{- $baseUrl := $src -}}
  
  {{/* Check if it's an Unsplash image that we can optimize */}}
  {{- if findRE "images\\.unsplash\\.com" $src -}}
    {{/* Generate Unsplash responsive srcset */}}
    {{- $srcsetItems := slice -}}
    {{- range $breakpoints -}}
      {{- $width := . -}}
      {{- $optimizedUrl := printf "%s&w=%d&q=80&auto=format" (replaceRE "&w=[0-9]+" "" $baseUrl) $width -}}
      {{- $srcsetItems = $srcsetItems | append (printf "%s %dw" $optimizedUrl $width) -}}
    {{- end -}}
    
    {{/* Generate WebP versions for Unsplash */}}
    {{- $webpSrcsetItems := slice -}}
    {{- range $breakpoints -}}
      {{- $width := . -}}
      {{- $webpUrl := printf "%s&w=%d&q=80&auto=format&fm=webp" (replaceRE "&w=[0-9]+" "" $baseUrl) $width -}}
      {{- $webpSrcsetItems = $webpSrcsetItems | append (printf "%s %dw" $webpUrl $width) -}}
    {{- end -}}
    
    <picture class="responsive-image{{ with $class }} {{ . }}{{ end }}">
      <source type="image/webp" 
              srcset="{{ delimit $webpSrcsetItems ", " }}" 
              sizes="{{ $sizes }}">
      <source type="image/jpeg" 
              srcset="{{ delimit $srcsetItems ", " }}" 
              sizes="{{ $sizes }}">
      <img src="{{ $src }}" 
           alt="{{ $alt }}"
           loading="{{ $loading }}"
           {{- with $fetchpriority }} fetchpriority="{{ . }}"{{ end }}
           {{- with $class }} class="{{ . }}"{{ end }}>
    </picture>
  
  {{/* For other external images, provide basic responsive behavior */}}
  {{- else -}}
    <img src="{{ $src }}" 
         alt="{{ $alt }}"
         loading="{{ $loading }}"
         {{- with $fetchpriority }} fetchpriority="{{ . }}"{{ end }}
         {{- with $class }} class="responsive-image{{ with $class }} {{ . }}{{ end }}"{{ end }}
         style="width: 100%; height: auto; max-width: 100%;">
  {{- end -}}
{{- end -}}