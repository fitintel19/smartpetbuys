{{/* Usage:  {{< product id="kibble-01" >}}  */}}
{{ $id := .Get "id" }}
{{ $p  := index site.Data.products $id }}
{{ if not $p }}
<p style="color:#b00">Product id '{{ $id }}' not found.</p>
{{ else }}
  {{/* Schema validation: Check for required fields to ensure Google compliance */}}
  {{ $hasBrand := and $p.brand (ne $p.brand "") }}
  {{ $hasRating := and $p.rating (ne $p.rating "") }}
  {{ $hasReviewCount := and $p.review_count (ne $p.review_count "") }}
  {{ $hasPrice := and $p.price (ne $p.price "") }}
  {{ $hasAllRequiredFields := and $hasBrand $hasRating $hasReviewCount }}
  
  {{/* Build validation message for missing fields */}}
  {{ $missingFields := slice }}
  {{ if not $hasBrand }}{{ $missingFields = $missingFields | append "brand" }}{{ end }}
  {{ if not $hasRating }}{{ $missingFields = $missingFields | append "rating" }}{{ end }}
  {{ if not $hasReviewCount }}{{ $missingFields = $missingFields | append "review_count" }}{{ end }}
  {{ if not $hasPrice }}{{ $missingFields = $missingFields | append "price" }}{{ end }}
  
  {{/* Hugo build warning for incomplete products */}}
  {{ if not $hasAllRequiredFields }}
    {{ warnf "Product '%s' missing schema fields for Google compliance: %s" $id (delimit $missingFields ", ") }}
  {{ end }}
<article class="product-card" itemscope itemtype="https://schema.org/Product" role="region" aria-labelledby="product-{{ $id }}-title">
  <div class="product-image-container">
    {{ if $p.image }}
    <img src="{{ $p.image }}" 
         alt="{{ $p.name }} - {{ $p.blurb | default "Pet product" | truncate 50 "..." }}" 
         itemprop="image" 
         loading="lazy"
         class="product-image">
    {{ else }}
    <div class="product-image-placeholder" role="presentation" aria-hidden="true">
      <svg class="product-placeholder-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
      </svg>
    </div>
    {{ end }}
    {{ if $p.brand }}
    <div class="product-brand-badge" itemprop="brand">{{ $p.brand }}</div>
    {{ end }}
  </div>
  
  <div class="product-content">
    <div class="product-header">
      <h3 id="product-{{ $id }}-title" class="product-title" itemprop="name">{{ $p.name }}</h3>
      {{ if $p.price }}
      <div class="product-price" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
        <meta itemprop="availability" content="https://schema.org/InStock">
        <meta itemprop="priceCurrency" content="USD">
        <meta itemprop="price" content="{{ $p.price }}">
        <span class="price-label">From</span>
        <span class="price-value">${{ $p.price }}</span>
      </div>
      {{ end }}
    </div>
    
    {{ if $p.rating }}
    <div class="product-rating" itemprop="aggregateRating" itemscope itemtype="https://schema.org/AggregateRating" role="img" aria-label="{{ $p.rating }} out of 5 stars rating based on {{ $p.review_count | default "50" }} reviews">
      <meta itemprop="ratingValue" content="{{ $p.rating }}">
      <meta itemprop="bestRating" content="5">
      <meta itemprop="worstRating" content="1">
      <meta itemprop="ratingCount" content="{{ $p.review_count | default "50" | replaceRE "[^0-9]" "" }}">
      <div class="rating-stars" aria-hidden="true">
        {{ $rating := $p.rating | float }}
        {{ range seq 1 5 }}
        <span class="star {{ if le . $rating }}filled{{ else if and (gt $rating (sub . 1)) (lt $rating .) }}half{{ end }}">â˜…</span>
        {{ end }}
      </div>
      <span class="rating-text">{{ $p.rating }} ({{ $p.review_count | default "50" }} reviews)</span>
    </div>
    {{ end }}
    
    {{ if $p.blurb }}
    <p class="product-description" itemprop="description" aria-describedby="product-{{ $id }}-title">{{ $p.blurb }}</p>
    {{ end }}
    
    <div class="product-actions">
      <a href="{{ $p.url }}" 
         rel="nofollow sponsored" 
         target="_blank" 
         class="product-cta-button" 
         itemprop="url" 
         aria-label="Check price for {{ $p.name }} (opens in new tab)">
        <span class="cta-text">Check Price</span>
        <svg class="cta-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
        </svg>
      </a>
    </div>
  </div>
</article>

<!-- Product JSON-LD Schema -->
<script type="application/ld+json">
{{/* 
  Product Schema.org JSON-LD for Google Search compliance
  Required by Google: name, brand, offers
  Recommended: aggregateRating, review, image, description
  For products without ratings/reviews, we provide offers only (still valid)
*/}}
{
  "@context": "https://schema.org",
  "@type": "Product",
  "name": "{{ $p.name }}",
  "description": "{{ $p.blurb | default $p.name }}",
  "image": "{{ $p.image }}",
  "brand": {
    "@type": "Brand",
    "name": "{{ $p.brand | default "Unknown Brand" }}"
  },
  {{ if $p.rating }}
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ $p.rating }}",
    "bestRating": "5",
    "worstRating": "1",
    "ratingCount": {{ $p.review_count | default "50" | replaceRE "[^0-9]" "" }}
  },
  {{ end }}
  {{ if $p.rating }}
  "review": [
    {
      "@type": "Review",
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": "{{ $p.rating }}",
        "bestRating": "5",
        "worstRating": "1"
      },
      "author": {
        "@type": "Organization",
        "name": "SmartPetBuys Team"
      },
      "reviewBody": "{{ $p.blurb | default $p.name }}"
    }
  ],
  {{ end }}
  "offers": {
    "@type": "Offer",
    "availability": "https://schema.org/InStock",
    "priceCurrency": "USD",
    {{ if $p.price }}"price": "{{ $p.price }}",
    "priceSpecification": {
      "@type": "PriceSpecification",
      "price": "{{ $p.price }}",
      "priceCurrency": "USD"
    },{{ else }}"price": "0.00",
    "priceSpecification": {
      "@type": "PriceSpecification",
      "price": "0.00",
      "priceCurrency": "USD"
    },{{ end }}
    "priceValidUntil": "{{ now.AddDate 1 0 0 | dateFormat "2006-01-02" }}",
    "url": "{{ $p.url }}"
  }
}
</script>
{{ end }}