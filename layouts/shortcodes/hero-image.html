{{/* 
Hugo shortcode for hero images with optimized responsive behavior
Usage: {{< hero-image src="image.jpg" alt="Description" >}}
*/}}

{{- $src := .Get "src" -}}
{{- $alt := .Get "alt" | default "" -}}
{{- $class := .Get "class" | default "hero-image" -}}

{{/* Hero-specific sizes attribute for optimal loading */}}
{{- $sizes := "(max-width: 414px) 100vw, (max-width: 768px) 100vw, (max-width: 1024px) 100vw, 1200px" -}}

{{/* Mobile-first breakpoints optimized for hero images */}}
{{- $heroBreakpoints := slice 414 568 768 1024 1200 1600 -}}

{{/* Try to get image as resource if it's local */}}
{{- $image := false -}}
{{- $isLocal := false -}}

{{/* Check if image is local */}}
{{- if or (hasPrefix $src "/") (not (findRE "://" $src)) -}}
  {{- $isLocal = true -}}
  {{- with resources.Get (strings.TrimPrefix "/" $src) -}}
    {{- $image = . -}}
  {{- end -}}
{{- end -}}

{{/* CSS Custom Properties for background image variants */}}
{{- $cssVars := dict -}}

{{/* If we have a local image resource, generate responsive variants */}}
{{- if $image -}}
  {{- $webpSrcset := slice -}}
  {{- $jpegSrcset := slice -}}
  
  {{/* Generate variants optimized for hero display */}}
  {{- range $heroBreakpoints -}}
    {{- $width := . -}}
    {{- if le $width $image.Width -}}
      {{/* Generate JPEG variant with hero-optimized quality */}}
      {{- $resizedJpeg := $image.Resize (printf "%dx q90" $width) -}}
      {{- $jpegSrcset = $jpegSrcset | append (printf "%s %dw" $resizedJpeg.RelPermalink $width) -}}
      
      {{/* Generate WebP variant */}}
      {{- $resizedWebp := $image.Resize (printf "%dx webp q90" $width) -}}
      {{- $webpSrcset = $webpSrcset | append (printf "%s %dw" $resizedWebp.RelPermalink $width) -}}
      
      {{/* Store URLs for CSS variables */}}
      {{- $cssVars = merge $cssVars (dict (printf "hero-bg-%d" $width) $resizedWebp.RelPermalink) -}}
    {{- end -}}
  {{- end -}}
  
  {{/* Generate fallback image */}}
  {{- $fallback := $image.Resize "1200x q90" -}}
  {{- $fallbackWebp := $image.Resize "1200x webp q90" -}}
  
  {{/* Output responsive hero image */}}
  <div class="post-featured-image {{ $class }}" 
       style="background-image: url('{{ $fallbackWebp.RelPermalink }}'), url('{{ $fallback.RelPermalink }}');"
       role="img" 
       aria-label="{{ $alt }}">
    {{/* Responsive background images using CSS custom properties */}}
    <style>
      @media (max-width: 414px) {
        .{{ $class }} {
          background-image: url('{{ index $cssVars "hero-bg-414" | default $fallbackWebp.RelPermalink }}');
        }
      }
      @media (min-width: 415px) and (max-width: 768px) {
        .{{ $class }} {
          background-image: url('{{ index $cssVars "hero-bg-568" | default $fallbackWebp.RelPermalink }}');
        }
      }
      @media (min-width: 769px) and (max-width: 1024px) {
        .{{ $class }} {
          background-image: url('{{ index $cssVars "hero-bg-768" | default $fallbackWebp.RelPermalink }}');
        }
      }
      @media (min-width: 1025px) {
        .{{ $class }} {
          background-image: url('{{ $fallbackWebp.RelPermalink }}');
        }
      }
    </style>
    
    {{/* Hidden img element for SEO and accessibility */}}
    <img src="{{ $fallback.RelPermalink }}" 
         alt="{{ $alt }}" 
         style="position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none;"
         fetchpriority="high">
  </div>

{{/* For external images like Unsplash */}}
{{- else -}}
  {{- $baseUrl := $src -}}
  
  {{/* Check if it's an Unsplash image that we can optimize */}}
  {{- if findRE "images\\.unsplash\\.com" $src -}}
    {{/* Generate optimized Unsplash URLs for different breakpoints */}}
    {{- $mobileUrl := printf "%s&w=414&q=85&auto=format&fm=webp" (replaceRE "&w=[0-9]+" "" $baseUrl) -}}
    {{- $tabletUrl := printf "%s&w=768&q=85&auto=format&fm=webp" (replaceRE "&w=[0-9]+" "" $baseUrl) -}}
    {{- $desktopUrl := printf "%s&w=1200&q=85&auto=format&fm=webp" (replaceRE "&w=[0-9]+" "" $baseUrl) -}}
    {{- $fallbackUrl := printf "%s&w=1200&q=85&auto=format" (replaceRE "&w=[0-9]+" "" $baseUrl) -}}
    
    <div class="post-featured-image {{ $class }}" 
         style="background-image: url('{{ $desktopUrl }}'), url('{{ $fallbackUrl }}');"
         role="img" 
         aria-label="{{ $alt }}">
      {{/* Responsive background images */}}
      <style>
        @media (max-width: 414px) {
          .{{ $class }} {
            background-image: url('{{ $mobileUrl }}');
          }
        }
        @media (min-width: 415px) and (max-width: 768px) {
          .{{ $class }} {
            background-image: url('{{ $tabletUrl }}');
          }
        }
        @media (min-width: 769px) {
          .{{ $class }} {
            background-image: url('{{ $desktopUrl }}');
          }
        }
      </style>
      
      {{/* Hidden img element for SEO */}}
      <img src="{{ $fallbackUrl }}" 
           alt="{{ $alt }}" 
           style="position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none;"
           fetchpriority="high">
    </div>
  
  {{/* For other external images, use simple responsive approach */}}
  {{- else -}}
    <div class="post-featured-image {{ $class }}" 
         style="background-image: url('{{ $src }}');"
         role="img" 
         aria-label="{{ $alt }}">
      <img src="{{ $src }}" 
           alt="{{ $alt }}" 
           style="position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none;"
           fetchpriority="high">
    </div>
  {{- end -}}
{{- end -}}