<!-- Font Performance Optimizations -->
<!-- Preconnect to Google Fonts for faster DNS resolution -->
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<!-- DNS-Prefetch for additional performance -->
<link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://fonts.gstatic.com">

<!-- Optimized Google Fonts loading with critical weight preload -->
<!-- Preload the most critical font weights first -->
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@400;600&display=swap" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@400;600&display=swap"></noscript>

<!-- Load additional font weights asynchronously for better performance -->
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;800&family=Open+Sans:wght@500&display=swap" onload="this.onload=null;this.rel='stylesheet'" media="print">
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;800&family=Open+Sans:wght@500&display=swap"></noscript>

<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

<!-- Impact Affiliate Marketing Verification -->
<meta name='impact-site-verification' content='7d696c1e-77f1-48f3-9591-eb00bef98cc2'>

<!-- Pinterest Site Verification -->
<meta name="p:domain_verify" content="06dada1659a02925f28a921a1723ba78"/>

<!-- MailerLite Universal -->
<script>
    (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
    .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
    n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
    (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
    ml('account', '1736326');
</script>
<!-- End MailerLite Universal -->

{{- $ga := (.Site.Params.ga4.id | default "G-HHVQX4ENNP") -}}
{{- if and $ga (eq hugo.Environment "production") -}}
<!-- Google Analytics - Optimized Loading with User Interaction -->
<script>
  // Initialize dataLayer immediately for tracking
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);} 
  gtag('js', new Date());
  gtag('config', '{{ $ga }}', {
    // Enhanced performance settings
    page_title: document.title,
    page_location: window.location.href,
    // Reduce impact on Core Web Vitals
    send_page_view: false
  });
  
  // Load GA script on user interaction or after delay
  function loadGA() {
    if (window.gaLoaded) return;
    window.gaLoaded = true;
    
    var gaScript = document.createElement('script');
    gaScript.async = true;
    gaScript.src = 'https://www.googletagmanager.com/gtag/js?id={{ $ga }}';
    gaScript.onload = function() {
      // Send page view after script loads
      gtag('event', 'page_view', {
        page_title: document.title,
        page_location: window.location.href
      });
    };
    document.head.appendChild(gaScript);
  }
  
  // Load GA on first user interaction
  ['mousedown', 'touchstart', 'keydown', 'scroll'].forEach(function(event) {
    document.addEventListener(event, loadGA, { once: true, passive: true });
  });
  
  // Fallback: load after 2 seconds if no interaction
  setTimeout(loadGA, 2000);
</script>
<script src="/js/ga-events.js" defer></script>
{{- end -}}

<!-- Schema.org Structured Data -->
{{ partial "schema-org.html" . }}

<!-- Critical CSS - Inline for fastest initial paint -->
<style>
{{- $critical := resources.Get "css/extended/critical.css" | resources.Minify -}}
{{ $critical.Content | safeCSS }}
</style>

<!-- Preload full stylesheet for after initial render -->
{{- $extended := (resources.Match "css/extended/*.css") | resources.Concat "assets/css/extended-full.css" | resources.Minify -}}
{{- if not site.Params.assets.disableFingerprinting -}}
{{- $extended = $extended | fingerprint -}}
{{- end -}}
<link rel="preload" as="style" href="{{ $extended.RelPermalink }}" onload="this.onload=null;this.rel='stylesheet'" crossorigin="anonymous">
<noscript><link rel="stylesheet" href="{{ $extended.RelPermalink }}" crossorigin="anonymous"></noscript>

<!-- Critical Resource Preloading - Optimized Priority Order -->
<!-- 1. Highest Priority - Above-the-fold critical scripts -->
<link rel="preload" as="script" href="/js/mobile-menu.js" crossorigin="anonymous">

<!-- 2. Logo and critical images -->
<link rel="preload" as="image" href="/images/smartpetbuys_logo.png" crossorigin="anonymous">
<link rel="preload" as="image" href="/favicon.ico" crossorigin="anonymous">

<!-- 3. Medium Priority - Analytics and tracking -->
<link rel="preload" as="script" href="/js/ga-events.js" crossorigin="anonymous">

<!-- 4. Lower Priority - Non-critical assets -->
<link rel="preload" as="script" href="/js/category-filter.js" crossorigin="anonymous">

<!-- Enhanced DNS Prefetch for external resources -->
<link rel="dns-prefetch" href="https://www.googletagmanager.com">
<link rel="dns-prefetch" href="https://assets.mailerlite.com">
<link rel="dns-prefetch" href="https://www.google-analytics.com">

<!-- Preconnect to high-priority origins with optimized timing -->
<link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
<link rel="preconnect" href="https://assets.mailerlite.com" crossorigin>

<!-- Early hints for resource discovery -->
<link rel="modulepreload" href="/js/mobile-menu.js">

<!-- Resource hints for better caching -->
<meta http-equiv="Cache-Control" content="public, max-age=31536000, immutable">

<!-- Mobile Menu JavaScript -->
<script src="/js/mobile-menu.js" defer></script>

<!-- Enhanced Social Media Meta Tags -->
{{ partial "enhanced-social-meta.html" . }}

<!-- Schema.org validation and enhancement -->
{{ partial "schema-validation.html" . }}

<!-- MailerLite Exit-Intent Popup (only for blog posts) -->
{{- if eq .Section "posts" }}
{{ partial "mailerlite-exit-intent.html" . }}
{{- end }}
