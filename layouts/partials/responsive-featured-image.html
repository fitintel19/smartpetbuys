{{/* 
Hugo partial for responsive featured images with optimized loading
Usage: {{ partial "responsive-featured-image.html" (dict "src" "image.jpg" "alt" "Description") }}
*/}}

{{- $src := .src -}}
{{- $alt := .alt | default "" -}}
{{- $class := .class | default "" -}}

{{/* Check if it's an Unsplash image that we can optimize */}}
{{- if findRE "images\\.unsplash\\.com" $src -}}
  {{/* Generate optimized Unsplash URLs for different breakpoints */}}
  {{- $mobileUrl := printf "%s&w=414&q=85&auto=format&fm=webp" (replaceRE "&w=[0-9]+" "" $src) -}}
  {{- $mobileFallback := printf "%s&w=414&q=85&auto=format" (replaceRE "&w=[0-9]+" "" $src) -}}
  {{- $tabletUrl := printf "%s&w=768&q=85&auto=format&fm=webp" (replaceRE "&w=[0-9]+" "" $src) -}}
  {{- $tabletFallback := printf "%s&w=768&q=85&auto=format" (replaceRE "&w=[0-9]+" "" $src) -}}
  {{- $desktopUrl := printf "%s&w=1200&q=85&auto=format&fm=webp" (replaceRE "&w=[0-9]+" "" $src) -}}
  {{- $desktopFallback := printf "%s&w=1200&q=85&auto=format" (replaceRE "&w=[0-9]+" "" $src) -}}
  
  <div class="post-featured-image{{ with $class }} {{ . }}{{ end }}" 
       role="img" 
       aria-label="{{ $alt }}">
    {{/* Inline CSS for responsive background images */}}
    <style>
      /* Default desktop WebP */
      .post-featured-image {
        background-image: url('{{ $desktopUrl }}');
      }
      
      /* Tablet WebP */
      @media (max-width: 1024px) and (min-width: 415px) {
        .post-featured-image {
          background-image: url('{{ $tabletUrl }}');
        }
      }
      
      /* Mobile WebP */
      @media (max-width: 414px) {
        .post-featured-image {
          background-image: url('{{ $mobileUrl }}');
        }
      }
      
      /* Fallback for browsers without WebP support */
      @supports not (background-image: url('data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA')) {
        .post-featured-image {
          background-image: url('{{ $desktopFallback }}');
        }
        
        @media (max-width: 1024px) and (min-width: 415px) {
          .post-featured-image {
            background-image: url('{{ $tabletFallback }}');
          }
        }
        
        @media (max-width: 414px) {
          .post-featured-image {
            background-image: url('{{ $mobileFallback }}');
          }
        }
      }
    </style>
    
    {{/* Hidden img element for SEO, preloading, and accessibility */}}
    <img src="{{ $desktopFallback }}" 
         alt="{{ $alt }}" 
         style="position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; z-index: -1;"
         fetchpriority="high"
         loading="eager">
         
    {{/* Preload critical images for better performance */}}
    <link rel="preload" as="image" href="{{ $mobileUrl }}" media="(max-width: 414px)">
    <link rel="preload" as="image" href="{{ $tabletUrl }}" media="(min-width: 415px) and (max-width: 1024px)">
    <link rel="preload" as="image" href="{{ $desktopUrl }}" media="(min-width: 1025px)">
  </div>

{{/* For Amazon images and other external sources */}}
{{- else if findRE "m\\.media-amazon\\.com" $src -}}
  {{/* Amazon images - use original but add responsive background properties */}}
  <div class="post-featured-image{{ with $class }} {{ . }}{{ end }}" 
       style="background-image: url('{{ $src }}');"
       role="img" 
       aria-label="{{ $alt }}">
    {{/* Add responsive background positioning for better mobile display */}}
    <style>
      .post-featured-image {
        background-size: cover;
        background-position: center center;
        background-repeat: no-repeat;
      }
      
      /* Optimize background positioning for mobile */
      @media (max-width: 768px) {
        .post-featured-image {
          background-position: center 30%;
        }
      }
    </style>
    
    <img src="{{ $src }}" 
         alt="{{ $alt }}" 
         style="position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; z-index: -1;"
         fetchpriority="high"
         loading="eager">
  </div>

{{/* For other external images, use simple responsive approach */}}
{{- else -}}
  <div class="post-featured-image{{ with $class }} {{ . }}{{ end }}" 
       style="background-image: url('{{ $src }}');"
       role="img" 
       aria-label="{{ $alt }}">
    <style>
      .post-featured-image {
        background-size: cover;
        background-position: center center;
        background-repeat: no-repeat;
      }
    </style>
    
    <img src="{{ $src }}" 
         alt="{{ $alt }}" 
         style="position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; z-index: -1;"
         fetchpriority="high"
         loading="eager">
  </div>
{{- end -}}